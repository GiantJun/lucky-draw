# 年会抽奖系统 - 完整需求文档

> 本文档详细描述年会抽奖系统的完整业务逻辑和技术实现细节，可作为完整复现该系统的参考文档。

## 目录

- [一、系统概述](#一系统概述)
- [二、数据结构定义](#二数据结构定义)
- [三、核心配置参数](#三核心配置参数)
- [四、抽奖流程详解](#四抽奖流程详解)
- [五、核心算法实现](#五核心算法实现)
- [六、特殊规则说明](#六特殊规则说明)
- [七、用户交互流程](#七用户交互流程)

---

## 一、系统概述

### 1.1 系统功能

这是一个基于 Vue 2 的 3D 标签云年会抽奖系统，支持灵活的奖品配置和多种抽奖模式。系统核心特点：

- 支持区分员工类型（正职/外包）
- 支持额外抽奖次数功能，提升特定人员中奖概率
- 支持分级抽奖策略配置
- 支持多等级奖品（特等奖/一等奖/二等奖/三等奖）
- 特一二等奖支持两种抽取模式：整个等级一次抽完、单独抽取具体奖品
- 三等奖支持单独抽取具体奖品
- 灵活的中奖规则控制

### 1.2 技术架构

- 前端框架：Vue 2.6
- UI 库：Element UI 2.13
- 状态管理：Vuex 3.1
- 本地存储：LocalStorage + IndexedDB
- 3D 效果：TagCanvas

---

## 二、数据结构定义

### 2.1 人员名单数据结构

**CSV 文件格式：**
```csv
人名,员工类型,额外抽奖次数
张三,正职,2
李四,外包,0
王五,正职,1
```

**JavaScript 对象结构：**
```javascript
{
  name: "张三",        // 人员真实姓名
  type: "正职",        // 员工类型：正职 | 外包
  extraTimes: 2        // 额外抽奖次数（0 表示只参与 1 次）
}
```

**说明：**
- `name`：人员的真实姓名，唯一标识一个人
- `type`：员工类型，用于奖品资格判断
- `extraTimes`：额外抽奖次数，实际参与次数 = extraTimes + 1（基础 1 次）
  - 当 `extraTimes = 2` 时，该人员在生效的等级中会显示为 "张三1"、"张三2"

### 2.2 奖品配置数据结构

**CSV 文件格式：**
```csv
奖品等级,奖品名称,数量,参与人员类别
特等奖,iPhone 15 Pro,1,正职
一等奖,iPad Air,2,正职
一等奖,AirPods Pro,1,正职
二等奖,小米手环,5,外包
三等奖,保温杯,10,全部
```

**JavaScript 对象结构：**
```javascript
{
  "特等奖": [
    {
      name: "iPhone 15 Pro",
      quantity: 1,
      eligibility: "正职"
    }
  ],
  "一等奖": [
    {
      name: "iPad Air",
      quantity: 2,
      eligibility: "正职"
    },
    {
      name: "AirPods Pro",
      quantity: 1,
      eligibility: "正职"
    }
  ]
}
```

**字段说明：**
- `奖品等级`：特等奖 | 一等奖 | 二等奖 | 三等奖
- `奖品名称`：具体奖品的名称
- `数量`：该奖品的数量
- `参与人员类别`：正职 | 外包 | 全部

### 2.3 抽奖结果数据结构

```javascript
{
  "特等奖": {
    "iPhone 15 Pro": [
      {
        displayName: "张三1",  // 显示名称（可能带数字后缀）
        realName: "张三",      // 真实姓名
        type: "正职"           // 员工类型
      }
    ]
  },
  "一等奖": {
    "iPad Air": [
      {
        displayName: "李四",
        realName: "李四",
        type: "外包"
      },
      {
        displayName: "王五2",
        realName: "王五",
        type: "正职"
      }
    ]
  }
}
```

**说明：**
- 结果数据按 **等级 → 奖品名称 → 中奖者列表** 三层结构存储
- `displayName`：候选时显示的名称，可能带数字后缀（如 "张三1"）
- `realName`：人员真实姓名，用于跨奖品中奖判断
- 中奖者数组的顺序即为中奖顺序

### 2.4 配置参数数据结构

```javascript
{
  name: "年会抽奖",                                    // 抽奖标题
  enableExtraTimes: true,                             // 额外抽奖次数功能开关
  extraTimesLevels: ["特等奖", "一等奖", "二等奖"],    // 额外抽奖次数生效的等级
  winnerExcludesAll: true                             // 一人中奖全部失效开关
}
```

---

## 三、核心配置参数

### 3.1 额外抽奖次数功能

**配置项：** `enableExtraTimes`

**可选值：**
- `true`：启用额外抽奖次数功能
- `false`：禁用额外抽奖次数功能

**功能说明：**

当 `enableExtraTimes = true` 时：
- 系统会读取人员名单中的 `extraTimes` 字段
- 在生效的奖品等级中，生成多个候选名（如 "张三1"、"张三2"）

当 `enableExtraTimes = false` 时：
- 系统忽略 `extraTimes` 字段
- 所有人员在所有等级中只显示真实姓名，只参与一次

**示例：**
```
人员：张三，extraTimes = 2

enableExtraTimes = true 且该等级生效：
候选池中显示: 张三1, 张三2

enableExtraTimes = false：
候选池中显示: 张三
```

### 3.2 额外抽奖次数生效等级

**配置项：** `extraTimesLevels`

**可选值：** `["特等奖", "一等奖", "二等奖", "三等奖"]` 的任意组合

**默认值：** `["特等奖", "一等奖", "二等奖"]`（不包含三等奖）

**功能说明：**

只有被勾选的等级才会应用额外抽奖次数，未勾选的等级所有人只出现一次。

**配置示例：**

| 配置 | 张三 extraTimes=2 | 特等奖候选池 | 一等奖候选池 | 二等奖候选池 | 三等奖候选池 |
|------|------------------|------------|------------|------------|------------|
| 默认配置（特一二生效） | ✅ | 张三1、张三2 | 张三1、张三2 | 张三1、张三2 | 张三 |
| 全部生效 | ✅ | 张三1、张三2 | 张三1、张三2 | 张三1、张三2 | 张三1、张三2 |
| 仅特等奖生效 | ✅ | 张三1、张三2 | 张三 | 张三 | 张三 |
| 关闭功能 | ❌ | 张三 | 张三 | 张三 | 张三 |

**典型应用场景：**
- **高等奖重点激励**：特一二等奖应用额外次数，提升重点人员获奖概率；三等奖公平分配
- **分层策略**：不同等级采用不同的激励策略
- **完全公平模式**：关闭功能或不勾选任何等级，所有人机会平等

### 3.3 一人中奖全部失效规则

**配置项：** `winnerExcludesAll`

**可选值：**
- `true`：一人中奖全部失效（默认）
- `false`：允许同一人的多个候选名分别中奖

**功能说明：**

**开关开启（`winnerExcludesAll = true`）：**
- 基于 `realName`（真实姓名）判断所有奖品
- 一旦某人中奖（无论是 "张三1" 还是 "张三2"），该人的所有候选名都失效
- 该人不能再参与任何后续抽奖

**示例：**
```
人员：张三，生成候选名：张三1、张三2

winnerExcludesAll = true：
- 张三1 中了特等奖后
- 张三2 不能再参与一等奖、二等奖、三等奖

winnerExcludesAll = false：
- 张三1 中了特等奖后
- 张三2 仍然可以参与其他奖品的抽奖
```

**开关关闭（`winnerExcludesAll = false`）：**
- 分情况判断：
  - **同一奖品内**：基于 `realName` 判断，防止 "张三1" 和 "张三2" 都中同一个奖品
  - **不同奖品间**：基于 `displayName` 判断，允许 "张三1" 中奖品 A，"张三2" 中奖品 B

**示例：**
```
人员：张三，生成候选名：张三1、张三2

winnerExcludesAll = false：
- 张三1 中了 iPhone 15 Pro 后
- 张三2 不能再中 iPhone 15 Pro（同一奖品，基于真实姓名判断）
- 但张三2 可以中 iPad Air（不同奖品，基于显示名称判断）
```

---

## 四、抽奖流程详解

### 4.1 抽奖前置准备

1. **导入人员名单**：上传 CSV 文件或加载示例数据
2. **导入奖品配置**：上传 CSV 文件或加载示例数据
3. **配置功能开关**：
   - 设置是否启用额外抽奖次数
   - 选择额外抽奖次数生效的等级
   - 设置一人中奖全部失效规则
4. **保存配置**

### 4.2 特等奖/一等奖/二等奖抽奖流程

#### 4.2.1 选择抽取模式

**模式一：整个等级一次抽完（默认模式）**

**适用场景：** 快速抽取该等级所有奖品，自动按顺序分配

**流程：**

1. 用户点击"开始"按钮
2. 选择奖品等级（如"一等奖"）
3. 选择抽取模式："一次抽取完整个等级"
4. 系统显示该等级所有奖品列表和剩余总数
5. 系统计算符合条件的候选人总数
6. 点击"立即抽奖"
7. 系统生成候选人池：
   - 遍历该等级下的所有奖品
   - 合并所有奖品的候选人（去重，基于 `displayName`）
8. 3D 标签云开始滚动，显示所有候选人
9. 点击"停止"按钮
10. 系统随机抽取 N 个中奖者（N = 该等级剩余奖品总数）
11. 系统按顺序分配奖品：
    - 遍历该等级下的奖品（按配置顺序）
    - 为每个奖品分配对应数量的中奖者
    - 示例：一等奖有 iPad Air x2 和 AirPods Pro x1，抽取 3 人
      - 前 2 人获得 iPad Air
      - 第 3 人获得 AirPods Pro
12. 显示中奖结果，每个中奖者卡片显示获得的具体奖品

**候选人生成规则（整个等级模式）：**

```javascript
// 1. 遍历该等级所有奖品
const allCandidatesMap = new Map();
prizes.forEach(prize => {
  // 2. 为每个奖品生成候选人
  const candidates = generateCandidates(prizeLevel, prize.name, prize, participants, result, config);

  // 3. 合并到总候选人池（基于 displayName 去重）
  candidates.forEach(candidate => {
    if (!allCandidatesMap.has(candidate.displayName)) {
      allCandidatesMap.set(candidate.displayName, candidate);
    }
  });
});

const allCandidates = Array.from(allCandidatesMap.values());
```

**奖品分配逻辑：**

```javascript
// 1. 随机抽取 N 个中奖者
const winners = randomSelectWinners(allCandidates, totalRemainQuantity);

// 2. 按奖品顺序分配中奖者
let winnerIndex = 0;
for (const prize of prizes) {
  // 计算该奖品剩余数量
  const prizeRemain = prize.quantity - alreadyWonCount;

  // 分配中奖者
  for (let i = 0; i < prizeRemain && winnerIndex < winners.length; i++) {
    assignPrizeToWinner(prize, winners[winnerIndex]);
    winnerIndex++;
  }
}
```

**模式二：选择具体奖品**

**适用场景：** 灵活控制每个奖品的抽取时间和数量

**流程：**

1. 用户点击"开始"按钮
2. 选择奖品等级（如"一等奖"）
3. 选择抽取模式："选择具体奖品"
4. 选择具体奖品（如"iPad Air"）
5. 系统显示该奖品的总数、剩余数量、符合条件候选人数
6. 选择抽取方式：
   - 抽 1 人
   - 抽 5 人
   - 一次抽取完（该奖品所有剩余数量）
   - 自定义人数
7. 点击"立即抽奖"
8. 系统生成该奖品的候选人池
9. 3D 标签云开始滚动，显示候选人
10. 点击"停止"按钮
11. 系统随机抽取指定数量的中奖者
12. 显示中奖结果（不显示奖品名称，因为已知是哪个奖品）

### 4.3 三等奖抽奖流程

**说明：** 三等奖只支持"选择具体奖品"模式

**流程：**

1. 用户点击"开始"按钮
2. 选择奖品等级："三等奖"
3. 选择具体奖品（如"保温杯"）
4. 系统显示该奖品的总数、剩余数量、符合条件候选人数
5. 选择抽取方式（抽 1 人/抽 5 人/一次抽取完/自定义）
6. 点击"立即抽奖"
7. 系统生成该奖品的候选人池
8. 3D 标签云开始滚动
9. 点击"停止"按钮
10. 随机抽取中奖者
11. 显示中奖结果

### 4.4 抽奖结果管理

**查看结果：**
- 点击右上角"抽奖结果"按钮
- 展示所有等级和奖品的中奖记录
- 按 **等级 → 奖品 → 中奖者** 层级展示

**删除中奖记录：**
- 点击中奖人员卡片
- 确认删除操作
- 删除该人员的中奖记录
- 该人员可以重新参与抽奖

**导出结果：**
- 点击"导出结果"按钮
- 生成 CSV 文件，包含：奖品等级、奖品名称、中奖者姓名、显示名称

---

## 五、核心算法实现

### 5.1 候选人生成算法

**函数签名：**
```javascript
function generateCandidates(
  prizeLevel,      // 奖品等级
  prizeName,       // 奖品名称
  prize,           // 奖品对象
  participants,    // 人员名单
  results,         // 抽奖结果
  config           // 配置参数
) -> Array<Candidate>
```

**算法步骤：**

```javascript
function generateCandidates(prizeLevel, prizeName, prize, participants, results, config) {
  const { enableExtraTimes, extraTimesLevels = [], winnerExcludesAll } = config;
  const candidates = [];

  // 步骤 1: 判断当前奖品等级是否应用额外抽奖次数
  const shouldApplyExtraTimes = enableExtraTimes && extraTimesLevels.includes(prizeLevel);

  // 步骤 2: 遍历所有参与人员
  participants.forEach(person => {
    // 步骤 2.1: 检查该人员工类型是否符合该奖品要求
    if (!isEligible(person.type, prize.eligibility)) {
      return; // 不符合，跳过
    }

    // 步骤 2.2: 根据配置决定是否应用额外抽奖次数
    if (shouldApplyExtraTimes && person.extraTimes > 0) {
      // 生成多个候选名: 张三1, 张三2, ...
      for (let i = 1; i <= person.extraTimes; i++) {
        const displayName = `${person.name}${i}`;

        // 检查是否已中奖
        if (hasWon(displayName, person.name, results, winnerExcludesAll, prizeLevel, prizeName)) {
          continue; // 已中奖，跳过
        }

        candidates.push({
          displayName: displayName,
          realName: person.name,
          type: person.type
        });
      }
    } else {
      // 不应用额外抽奖次数：只生成一个候选名（不带数字后缀）
      const displayName = person.name;

      // 检查是否已中奖
      if (hasWon(displayName, person.name, results, winnerExcludesAll, prizeLevel, prizeName)) {
        return; // 已中奖，跳过
      }

      candidates.push({
        displayName: person.name,
        realName: person.name,
        type: person.type
      });
    }
  });

  return candidates;
}
```

**关键点：**
1. 先判断人员类型是否符合奖品要求
2. 再判断是否应用额外抽奖次数
3. 最后判断是否已中奖

### 5.2 中奖判断算法

**函数签名：**
```javascript
function hasWon(
  displayName,        // 显示名称（如 "张三1"）
  realName,           // 真实姓名（如 "张三"）
  results,            // 抽奖结果
  winnerExcludesAll,  // 一人中奖全部失效开关
  currentPrizeLevel,  // 当前奖品等级
  currentPrizeName    // 当前奖品名称
) -> Boolean
```

**算法步骤：**

```javascript
function hasWon(displayName, realName, results, winnerExcludesAll, currentPrizeLevel, currentPrizeName) {
  // 情况 1: 一人中奖全部失效开关开启
  if (winnerExcludesAll) {
    // 基于真实姓名判断所有奖品，一人中奖则全部候选名失效
    for (const level in results) {
      for (const prizeName in results[level]) {
        const winners = results[level][prizeName] || [];
        if (winners.some(w => w.realName === realName)) {
          return true; // 该人已中奖，排除
        }
      }
    }
    return false; // 未中奖，可以参与
  }

  // 情况 2: 一人中奖全部失效开关关闭
  else {
    // 分情况判断
    for (const level in results) {
      for (const prizeName in results[level]) {
        const winners = results[level][prizeName] || [];

        // 判断是否是当前正在抽的奖品
        if (level === currentPrizeLevel && prizeName === currentPrizeName) {
          // 当前奖品：基于真实姓名判断（防止张三1和张三2都中同一个奖品）
          if (winners.some(w => w.realName === realName)) {
            return true; // 该人已中此奖品，排除
          }
        } else {
          // 其他奖品：基于显示名称判断（允许张三1中奖品A，张三2中奖品B）
          if (winners.some(w => w.displayName === displayName)) {
            return true; // 该显示名称已中其他奖品，排除
          }
        }
      }
    }
    return false; // 未中奖，可以参与
  }
}
```

**判断逻辑总结：**

| 开关状态 | 同一奖品内 | 不同奖品间 |
|---------|-----------|-----------|
| `winnerExcludesAll = true` | 基于 `realName` | 基于 `realName` |
| `winnerExcludesAll = false` | 基于 `realName` | 基于 `displayName` |

### 5.3 人员类型资格判断

**函数签名：**
```javascript
function isEligible(personType, eligibility) -> Boolean
```

**算法实现：**
```javascript
function isEligible(personType, eligibility) {
  // 如果奖品要求是"全部"，所有人都符合
  if (eligibility === '全部') {
    return true;
  }
  // 否则人员类型必须匹配奖品要求
  return personType === eligibility;
}
```

**示例：**
```
奖品要求: "正职" → 只有正职员工符合
奖品要求: "外包" → 只有外包员工符合
奖品要求: "全部" → 所有人都符合
```

### 5.4 随机抽取算法

**函数签名：**
```javascript
function randomSelectWinners(candidates, num) -> Array<Candidate>
```

**算法实现：**
```javascript
function randomSelectWinners(candidates, num) {
  const winners = [];
  const selectedIndices = new Set(); // 记录已选中的索引，避免重复

  // 检查候选人数量是否足够
  if (candidates.length < num) {
    throw new Error('候选人数量不足');
  }

  // 循环抽取，直到抽满
  while (winners.length < num) {
    // 生成随机索引
    const index = randomNum(0, candidates.length - 1);

    // 如果该索引未被选中
    if (!selectedIndices.has(index)) {
      selectedIndices.add(index);
      winners.push(candidates[index]);
    }
  }

  return winners;
}

// 辅助函数：生成随机整数
function randomNum(minNum, maxNum) {
  return parseInt(Math.random() * (maxNum - minNum + 1) + minNum, 10);
}
```

**特点：**
- 使用 `Set` 确保不会重复抽取同一个候选人
- 基于 `Math.random()` 实现随机性
- 简单高效

---

## 六、特殊规则说明

### 6.1 额外抽奖次数机制

#### 6.1.1 基本概念

**定义：** 为特定人员提供多次参与抽奖的机会，提升其中奖概率

**实现方式：** 在候选人池中生成多个候选名（如 "张三1"、"张三2"）

**配置示例：**
```
人员：张三
额外抽奖次数：2
实际参与次数：2（extraTimes 直接表示总次数）
候选名：张三1, 张三2
```

#### 6.1.2 生效范围控制

**可按等级控制是否生效：**

| 配置 | 特等奖 | 一等奖 | 二等奖 | 三等奖 |
|------|-------|-------|-------|-------|
| 默认 | ✅ 生效 | ✅ 生效 | ✅ 生效 | ❌ 不生效 |
| 仅特等奖 | ✅ 生效 | ❌ 不生效 | ❌ 不生效 | ❌ 不生效 |
| 全部生效 | ✅ 生效 | ✅ 生效 | ✅ 生效 | ✅ 生效 |

**示例：张三 extraTimes = 2**

默认配置（特一二生效）：
- 特等奖候选池：张三1、张三2
- 一等奖候选池：张三1、张三2
- 二等奖候选池：张三1、张三2
- 三等奖候选池：张三（只有一个）

#### 6.1.3 中奖概率计算

**假设场景：**
- 总人数：100 人
- 张三 extraTimes = 2，其他人 extraTimes = 0
- 抽取 1 个特等奖

**候选池：**
- 张三1、张三2、李四、王五、...（共 101 个候选名）

**张三的中奖概率：**
```
P(张三中奖) = P(张三1 被抽中) + P(张三2 被抽中)
            = 1/101 + 1/101
            = 2/101
            ≈ 1.98%

其他人的中奖概率 = 1/101 ≈ 0.99%
```

**结论：** 张三的中奖概率是其他人的 2 倍

### 6.2 一人中奖全部失效规则

#### 6.2.1 开关开启（默认）

**规则：** 一旦某人中奖，该人的所有候选名都失效，不能再参与任何后续抽奖

**示例：**
```
人员：张三，候选名：张三1、张三2

抽奖顺序：
1. 特等奖抽奖 → 张三1 中奖
2. 一等奖抽奖 → 张三1 和 张三2 都不在候选池中
3. 二等奖抽奖 → 张三1 和 张三2 都不在候选池中
```

**适用场景：**
- 确保公平性，每人最多中一个奖
- 防止少数人垄断多个奖品

#### 6.2.2 开关关闭

**规则：**
- **同一奖品内**：同一人的不同候选名不能都中同一个奖品
- **不同奖品间**：不同的候选名可以分别中不同的奖品

**示例：**
```
人员：张三，候选名：张三1、张三2

场景 1: 抽取 iPhone 15 Pro（数量 1）
- 张三1 中奖 → 张三2 不能再中 iPhone 15 Pro

场景 2: 抽取 iPhone 15 Pro 后，再抽取 iPad Air
- 张三1 已中 iPhone 15 Pro
- 张三2 仍可以参与 iPad Air 的抽奖

场景 3: 抽取 iPad Air（数量 2）
- 可能结果：张三1 和 李四 中奖
- 不可能结果：张三1 和 张三2 同时中奖（同一人）
```

**适用场景：**
- 允许同一人中多个奖品
- 增加额外抽奖次数的实际收益

### 6.3 奖品资格限制

**规则：** 根据人员类型（正职/外包）限制奖品参与资格

**配置示例：**
```csv
奖品等级,奖品名称,数量,参与人员类别
特等奖,iPhone 15 Pro,1,正职        ← 只有正职可参与
一等奖,iPad Air,2,外包              ← 只有外包可参与
二等奖,小米手环,5,全部              ← 所有人可参与
```

**判断逻辑：**
```javascript
function isEligible(personType, eligibility) {
  if (eligibility === '全部') return true;
  return personType === eligibility;
}
```

**示例：**
```
张三：正职
李四：外包

iPhone 15 Pro（要求：正职）：
- 张三：✅ 可以参与
- 李四：❌ 不能参与

iPad Air（要求：外包）：
- 张三：❌ 不能参与
- 李四：✅ 可以参与

小米手环（要求：全部）：
- 张三：✅ 可以参与
- 李四：✅ 可以参与
```

### 6.4 特一二等奖的两种抽取模式

#### 6.4.1 整个等级一次抽完模式

**特点：**
- 一次性抽取该等级所有剩余奖品
- 系统自动按顺序分配奖品给中奖者
- 效率高，适合快速抽奖

**候选池生成：**
- 合并该等级所有奖品的候选人（去重）
- 基于 `displayName` 去重，避免重复

**奖品分配顺序：**
按奖品配置顺序依次分配

**示例：**
```
一等奖配置：
- iPad Air x 2
- AirPods Pro x 1

抽取 3 个中奖者：张三1、李四、王五

分配结果：
- 张三1 → iPad Air
- 李四 → iPad Air
- 王五 → AirPods Pro
```

#### 6.4.2 单独抽取具体奖品模式

**特点：**
- 灵活选择抽取哪个奖品
- 可以控制每个奖品的抽取时间和数量
- 适合需要分批抽奖的场景

**示例：**
```
用户操作：
1. 先抽取 AirPods Pro x 1
2. 再抽取 iPad Air x 1
3. 最后抽取 iPad Air x 1
```

---

## 七、用户交互流程

### 7.1 初始配置流程

```
1. 用户打开系统
   ↓
2. 点击"抽奖配置"按钮
   ↓
3. 选择配置方式：
   ├─→ 方式一：点击"加载示例数据"（快速体验）
   │   ├─→ 系统加载示例人员名单和奖品配置
   │   └─→ 显示导入成功提示
   │
   └─→ 方式二：导入自定义 CSV
       ├─→ 点击"人员名单" → "导入CSV"
       ├─→ 选择人员名单 CSV 文件
       ├─→ 显示导入成功提示（如：已导入 50 人）
       ├─→ 点击"奖品配置" → "导入CSV"
       ├─→ 选择奖品配置 CSV 文件
       └─→ 显示导入成功提示（如：已导入 4 个奖项）
   ↓
4. 配置功能开关：
   ├─→ 额外抽奖次数：开启/关闭
   ├─→ 生效的奖品等级：勾选特等奖、一等奖、二等奖、三等奖
   └─→ 一人中奖全部失效：开启/关闭
   ↓
5. 点击"保存配置"
   ↓
6. 系统提示"保存成功"，配置完成
```

### 7.2 特一二等奖抽奖流程（整个等级模式）

```
1. 点击右侧"开始"按钮
   ↓
2. 弹出抽奖配置对话框
   ↓
3. 选择奖品等级（如"一等奖"）
   ↓
4. 抽取模式自动默认为"一次抽取完整个等级"
   ↓
5. 系统显示：
   ├─→ 奖品列表：iPad Air x 2, AirPods Pro x 1
   ├─→ 等级总数：3
   ├─→ 剩余数量：3（假设都未抽）
   └─→ 符合条件候选人：100
   ↓
6. 点击"立即抽奖"
   ↓
7. 系统播放抽奖音乐，3D 标签云快速旋转
   ├─→ 标签云中显示所有候选人的名字
   └─→ 名字随机分布在 3D 空间中
   ↓
8. 用户点击"停止"按钮
   ↓
9. 3D 标签云减速，音乐切换回背景音乐
   ↓
10. 系统显示中奖结果：
    ├─→ 标题："一等奖抽奖结果："
    ├─→ 中奖者卡片：
    │   ├─→ 张三1 - iPad Air（红色标签）
    │   ├─→ 李四 - iPad Air（红色标签）
    │   └─→ 王五 - AirPods Pro（红色标签）
    └─→ 每个卡片显示照片（如有）和获得的奖品
   ↓
11. 点击结果区域关闭，回到主界面
```

### 7.3 单独抽取具体奖品流程

```
1. 点击右侧"开始"按钮
   ↓
2. 选择奖品等级（如"一等奖"或"三等奖"）
   ↓
3. 选择抽取模式："选择具体奖品"（特一二等奖需选择，三等奖默认）
   ↓
4. 选择具体奖品（如"iPad Air"）
   ↓
5. 系统显示：
   ├─→ 奖品总数：2
   ├─→ 剩余数量：2
   └─→ 符合条件候选人：100
   ↓
6. 选择抽取方式：
   ├─→ 抽 1 人
   ├─→ 抽 5 人
   ├─→ 一次抽取完（该奖品所有剩余）
   └─→ 自定义（输入数量）
   ↓
7. 点击"立即抽奖"
   ↓
8. 3D 标签云开始旋转，显示候选人
   ↓
9. 点击"停止"
   ↓
10. 显示中奖结果（不显示奖品名称，因为已知）
   ↓
11. 点击关闭
```

### 7.4 查看和管理结果流程

```
1. 点击右上角"抽奖结果"按钮
   ↓
2. 弹出结果对话框，显示：
   ├─→ 特等奖
   │   └─→ iPhone 15 Pro：张三1
   ├─→ 一等奖
   │   ├─→ iPad Air：李四、王五
   │   └─→ AirPods Pro：赵六
   ├─→ 二等奖
   │   └─→ 小米手环：...
   └─→ 三等奖
       └─→ 保温杯：...
   ↓
3. 管理操作：
   ├─→ 删除中奖记录：
   │   ├─→ 点击中奖人卡片（如"张三1"）
   │   ├─→ 弹出确认对话框："确认删除张三1的中奖记录？"
   │   ├─→ 点击"确定"
   │   ├─→ 系统删除该记录
   │   ├─→ 张三1 可以重新参与抽奖
   │   └─→ 显示"删除成功"提示
   │
   └─→ 导出结果：
       ├─→ 点击"导出结果"按钮
       ├─→ 系统生成 CSV 文件
       ├─→ 文件名：抽奖结果_2025-01-15T10-30-00.csv
       ├─→ 文件内容：
       │   奖品等级,奖品名称,中奖者姓名,显示名称
       │   特等奖,iPhone 15 Pro,张三,张三1
       │   一等奖,iPad Air,李四,李四
       │   一等奖,iPad Air,王五,王五
       └─→ 浏览器自动下载文件
   ↓
4. 点击对话框外部或关闭按钮，关闭对话框
```

### 7.5 重置功能流程

```
1. 点击右侧"重置"按钮
   ↓
2. 弹出重置选项对话框
   ↓
3. 选择重置类型：
   ├─→ 重置全部数据（清空所有）
   ├─→ 重置抽奖配置（仅清空配置）
   ├─→ 重置人员名单（仅清空人员）
   ├─→ 重置奖品配置（仅清空奖品）
   ├─→ 重置照片（仅清空照片）
   └─→ 重置抽奖结果（仅清空结果）
   ↓
4. 点击"确定重置"
   ↓
5. 弹出二次确认："此操作将重置所选数据，是否继续？"
   ↓
6. 点击"确定"
   ↓
7. 系统执行重置操作
   ↓
8. 显示"重置成功"提示
   ↓
9. 对话框自动关闭
```

---

## 八、数据持久化

### 8.1 LocalStorage 存储

**存储内容：**
- `config`：配置参数
- `result`：抽奖结果
- `participants`：人员名单
- `prizes`：奖品配置

**存储时机：**
- 保存配置时
- 每次抽奖结束时
- 删除中奖记录时

### 8.2 IndexedDB 存储

**存储内容：**
- 照片数据（Base64 格式）

**数据结构：**
```javascript
{
  id: 1,                    // 抽奖号码
  name: "张三",             // 人员姓名
  value: "data:image/..."   // Base64 图片数据
}
```

---

## 九、前端展示逻辑

### 9.1 3D 标签云

**技术：** TagCanvas

**显示规则：**
- 抽奖前：显示所有参与人员的样本（最多 500 人）
- 抽奖时：显示当前奖品的候选人池
- 标签内容：
  - 显示 `displayName`（如 "张三1"）
  - 如果有照片，显示照片缩略图

### 9.2 中奖结果展示

**布局：**
- 标题：显示奖品等级和名称
- 卡片列表：每个中奖者一个卡片

**卡片内容：**
- 无照片：显示 `displayName` 和奖品名称（整个等级模式）
- 有照片：显示照片和奖品名称标签（整个等级模式）

**字体大小：**
根据参与人数自动调整：
- < 100 人：100px
- < 1000 人：80px
- < 10000 人：60px
- ≥ 10000 人：30px

---

## 十、边界条件处理

### 10.1 候选人数量不足

**场景：** 抽取人数 > 符合条件的候选人数量

**处理：** 显示错误提示 "符合条件的候选人数量不足"

### 10.2 奖品已抽完

**场景：** 某奖品剩余数量为 0

**处理：** 显示错误提示 "该奖品剩余数量不足"

### 10.3 数据未导入

**场景：** 未导入人员名单或奖品配置就开始抽奖

**处理：**
- 未导入人员：提示 "请先在抽奖配置中导入人员名单"
- 未导入奖品：提示 "请先在抽奖配置中导入奖品配置"

### 10.4 CSV 文件解析失败

**场景：** 上传的 CSV 文件格式不正确或包含无效数据

**处理：** 显示错误提示 "CSV文件解析失败或无有效数据"

---

## 十一、附录

### 11.1 CSV 文件模板

**人员名单模板：**
```csv
人名,员工类型,额外抽奖次数
张三,正职,2
李四,外包,0
王五,正职,1
```

**奖品配置模板：**
```csv
奖品等级,奖品名称,数量,参与人员类别
特等奖,iPhone 15 Pro,1,正职
一等奖,iPad Air,2,正职
一等奖,AirPods Pro,1,正职
二等奖,小米手环,5,外包
三等奖,保温杯,10,全部
```

### 11.2 技术栈清单

- **前端框架：** Vue 2.6.11
- **UI 组件库：** Element UI 2.13.2
- **状态管理：** Vuex 3.1.0
- **路由：** Vue Router 3.1.0
- **3D 效果：** TagCanvas
- **构建工具：** Vue CLI 4.1.0
- **本地存储：** LocalStorage + IndexedDB

### 11.3 关键文件说明

| 文件路径 | 功能说明 |
|---------|---------|
| `src/App.vue` | 主应用组件，包含核心抽奖逻辑 |
| `src/store/index.js` | Vuex 状态管理，存储所有数据 |
| `src/helper/algorithm.js` | 核心算法：候选人生成、中奖判断、随机抽取 |
| `src/helper/index.js` | 工具函数：数据存储、CSV 解析 |
| `src/components/Tool.vue` | 抽奖配置对话框和控制按钮 |
| `src/components/LotteryConfig.vue` | 配置界面，CSV 导入 |
| `src/components/Result.vue` | 结果展示和管理 |

---

## 十二、总结

本文档详细描述了年会抽奖系统的完整业务逻辑和技术实现细节，涵盖：

1. **数据结构**：人员、奖品、结果、配置的完整定义
2. **核心算法**：候选人生成、中奖判断、随机抽取的详细实现
3. **业务规则**：额外抽奖次数、中奖规则、资格限制等
4. **用户流程**：从配置到抽奖到结果管理的完整交互
5. **边界处理**：各种异常情况的处理方案

通过本文档，其他开发者或 AI 可以完整复现该抽奖系统的所有功能和逻辑。